services:

  # https://hub.docker.com/r/pingcap/pd
  pd:  
    container_name: pd
    image: pingcap/pd:latest
    ports:
      - "2379"
    volumes:
      - ./config/pd.toml:/pd.toml:ro
      - ./data:/data
      - ./logs:/logs
    command:
      - --name=pd
      - --client-urls=http://0.0.0.0:2379
      - --advertise-client-urls=http://pd:2379
      - --peer-urls=http://0.0.0.0:2380
      - --advertise-peer-urls=http://pd:2380
    networks:
      - shop-net

  # https://hub.docker.com/r/pingcap/tikv
  tikv:
    image: pingcap/tikv:latest
    container_name: tikv
    command:
      - --addr=0.0.0.0:20160
      - --advertise-addr=tikv:20160
      - --pd=pd:2379
      - --data-dir=/tikv/data
    depends_on:
      - pd
    volumes:
      - tikv-data:/tikv/data
    restart: unless-stopped
    networks:
      - shop-net

  # https://hub.docker.com/r/pingcap/tidb
  # https://github.com/pingcap/tidb
  tidb:
    image: pingcap/tidb:latest
    container_name: tidb
    command:
      - --store=tikv
      - --path=pd:2379
    depends_on:
      - tikv
    ports:
      - "4000:4000"   # MySQL protocol
      - "10080:10080" # status / metrics
    restart: unless-stopped    
    networks:
      - shop-net

  init-db:
    build:
      context: ./init-db
    container_name: init-db
    depends_on:
      - tidb
    environment:
      - DB_HOST=tidb
      - DB_PORT=4000
      - DB_ROOT_USER=root
      # leave empty if TiDB root has no password
      - DB_ROOT_PASSWORD=
    restart: "no"
    networks:
      - shop-net
  # https://hub.docker.com/r/pingcap/ticdc
  ticdc:
    image: pingcap/ticdc:latest
    container_name: ticdc
    command:
      - /cdc
      - server
      - --pd=http://pd:2379
      - --addr=0.0.0.0:8300
      - --advertise-addr=ticdc:8300
      - --log-file=/logs/ticdc.log
    depends_on:
      - pd
    volumes:
      - ./logs:/logs
    restart: unless-stopped
    networks:
      - shop-net

  ticdc-init:
    image: pingcap/ticdc:latest
    container_name: init-ticdc
    depends_on:
      - ticdc
      - kafka
    volumes:
      - ./config/cdc-config.toml:/config/cdc-config.toml:ro
    command:
      - /bin/sh
      - -c
      - |
        sleep 10 && \
        /cdc cli --server=http://ticdc:8300 changefeed create \
          --changefeed-id=shop-changefeed \
          --sink-uri="kafka://kafka:9092/shop-db-data-changes?protocol=canal-json&partition-num=1&replication-factor=1" \
          --config=/config/cdc-config.toml \
        || /cdc cli --server=http://ticdc:8300 changefeed resume --changefeed-id=shop-changefeed
    networks:
      - shop-net
    restart: on-failure

  # =====================
  # Kafka Stack
  # =====================
  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.1
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    restart: unless-stopped
    networks:
      - shop-net

  kafka:
    image: confluentinc/cp-kafka:7.6.1
    container_name: kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    restart: unless-stopped
    networks:
      - shop-net

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    ports:
      - "8080:8080"
    depends_on:
      - kafka
      - zookeeper
    environment:
      KAFKA_CLUSTERS_0_NAME: local-kafka
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
    restart: unless-stopped
    networks:
      - shop-net

  # =====================
  # Consumer Stack
  # =====================
  # =====================
  # Consumer Stack
  # =====================

  shop-consumer:
    build:
      context: ./shop-consumer
    container_name: shop-consumer
    depends_on:
      - kafka
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - KAFKA_TOPIC=shop-db-data-changes
      - KAFKA_GROUP_ID=shop-consumer-group
      - METRICS_PORT=8000
      - LOG_FILE_PATH=/var/log/shop-consumer/consumer.log
    ports:
      - "8000:8000"   # Prometheus metrics / debugging
    volumes:
      - shop-consumer-logs:/var/log/shop-consumer
    restart: unless-stopped
    networks:
      - shop-net

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.13.0
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    ports:
      - "9200:9200"
    volumes:
      - es-data:/usr/share/elasticsearch/data
    networks:
      - shop-net
    restart: unless-stopped

  filebeat:
    image: docker.elastic.co/beats/filebeat:8.13.0
    container_name: filebeat
    user: root
    depends_on:
      - elasticsearch
      - shop-consumer
    volumes:
      - ./filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      - shop-consumer-logs:/var/log/shop-consumer:ro
    networks:
      - shop-net
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - --config.file=/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    networks:
      - shop-net
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    depends_on:
      - prometheus
      - elasticsearch
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - ./monitoring/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources
      - ./monitoring/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards
    networks:
      - shop-net
    restart: unless-stopped

volumes:
  pd-data:
  tikv-data:
  es-data:
  shop-consumer-logs:

networks:
  shop-net:
    name: shop-net